
map.on('load', function () {

 
var geojson = {
    "type": "FeatureCollection",
    "features": [
        {
            "type": "Feature",
            "properties": {
                "Name": "VILLA CREATIVE",
                "description": "<p>Positionnée dans l'ancien site de l'université des sciences, la villa creative supramuros est devenue l'un des lieux d'échanges intellectuels et scientifiques incontournables pendant le festival d'Avignon. A terme, il doit devenir un veritable culture lab et une plateforme consacrée à l'entrepreneuriat dans le champs de la Culture pour innover et créer au-dela des murs: Supramuros.\nCe «Culture lab» se nourrit de nombreuses expériences: il touche un nombre croissant de secteurs, à travers la multiplication d'espaces d'innovation hybrides, au carrefour de la pratique artistique, de l'ingénierie technologique et des sciences sociales.</p>",
                "SiteWeb": "<a href =\"http://www.univ-avignon.fr/\" target =\"_blank\"> http://www.univ-avignon.fr/",
                "Contac": "\nGrand Avignon Entreprendre<br> \nentreprendre@agglo-grandavignon.fr \n<br>04 90 84 48 20",
                "iconSize": [30, 30],
                "nameIcon": "villacreative_creativa",
                "slider": "<li><img src=\"images/puntos_img/universite1.jpg\" /></li>  <li><img src=\"images/puntos_img/universite2.jpg\"/></li>  <li><img src=\"images/puntos_img/opera3.jpg\" /></li>"
 

                },
            "geometry": {
                "type": "Point",
                "coordinates": [
                   4.81591904278, 43.9499983146,
                ]
            }
        },
         {
            "type": "Feature",
            "properties": {
                "Name": "MARCHE D'INTERET NATIONAL (MIN)",
                "description": "<p>Pôle européen d’innovation Fruits & Légumes, le 2ème MIN de France en terme de surface construite accueille une diversité d’activités de gros, d’exportation, mais aussi de nombreuses sociétés de services, et met à disposition des bureaux et entrepôts jusqu’à 1 200 m2.\nLes services du MIN sont particulièrement adaptés à l’accueil d’entreprises agroalimentaires, avec notamment un poids public et des places de stationnement adaptées.</p>",
                "SiteWeb": "<a href =\"http://www.minavignon.fr/\" target =\"_blank\"> http://www.minavignon.fr/",
                "Contac": "\nGrand Avignon Entreprendre<br> \nentreprendre@agglo-grandavignon.fr \n<br>04 90 84 48 20",
                "iconSize": [30, 30],
                "nameIcon": "min",
                "slider": "<li><img src=\"images/puntos_img/min1.jpg\" /></li>"

            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                    4.83851663497,  43.9320623172,
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "Name": "CREATIVA",
                "description": "<p>Pépinière de plus de 130 entreprises au cœur du technopôle du Grand Avignon, Agroparc, Créativa accompagne les néoentrepreneurs de tous secteurs d’activités confondus, favorisant les synergies et opportunités business sur le territoire.\nLa pépinière offre des prestations de qualité permettant gain de temps et d’argent pour la jeune entreprise.</p>",
                "SiteWeb": "<a href =\"http://www.minavignon.fr/\" target =\"_blank\"> http://www.minavignon.fr/",
                "Contac": "\nGrand Avignon Entreprendre<br> \nentreprendre@agglo-grandavignon.fr \n<br>04 90 84 48 20",
                "iconSize": [30, 30],
                "nameIcon": "villacreative_creativa",
                "slider": "<li><img src=\"images/puntos_img/creativa1.jpg\" /></li>  <li><img src=\"images/puntos_img/creativa2.jpg\"/></li>  <li><img src=\"images/puntos_img/creativa3.jpg\" /></li>"

            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                    4.89065796251, 43.9099793732,

                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "Name": "PEPINIERE PEGASE",
                "description": "<p>La pépinière Pegase occupe 2500m² d’ateliers, bureaux ou hangars, disposant d’un accès direct aux pistes de l'aéroport d'Avignon-Provence. Les entreprises hébergées peuvent ainsi réaliser les essais de leurs technologies et de leurs appareils (drones, ULM...).\nInaugurée en 2015, ce bâtiment préfigure le développement d’une zone d’activité aéronautique qui sera opérationnelle dès 2017.</p>",
                "SiteWeb": "<a href =\"http://www.safecluster.com/\" target =\"_blank\"> http://www.safecluster.com/",
                "Contac": "\nGrand Avignon Entreprendre<br> \nentreprendre@agglo-grandavignon.fr \n<br>04 90 84 48 20",
                "iconSize": [30, 30],
                "nameIcon": "pepinierepegase",
                "slider": "<li><img src=\"images/puntos_img/pegase4.jpg\" /></li>  <li><img src=\"images/puntos_img/pegase1.jpg\"/></li>  <li><img src=\"images/puntos_img/pegase2.jpg\" /></li>"


            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                   4.89764595418, 43.9098239447,
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "Name": "TECHNICITE",
                "description": "<p>Situé sur le technopôle du Grand Avignon, Agroparc, Technicité dispose de plateformes et bureaux pour recevoir  prioritairement des sociétés innovantes, start-up, R&D, sous-traitants industriels (notamment spécialisés dans l’agroalimentaire), entreprises technologiques.\nTechnicité met à disposition des espaces communs et des services haut de gamme à deux pas du centre animé de la zone.</p>",
                "SiteWeb": "<a href =\"http://www.citadis-avignon.com/index.php/references-construction/immobiliers-dentreprises/328-avignon-chateau-de-la-barbiere\" target =\"_blank\"> http://www.citadis-avignon.com/index.php/references-construction/immobiliers-dentreprises/328-avignon-chateau-de-la-barbiere",
                "Contac": "\nGrand Avignon Entreprendre<br> \nentreprendre@agglo-grandavignon.fr \n<br>04 90 84 48 20", 
                "iconSize": [30, 30],
                "nameIcon": "technicite",
                "slider": "<li><img src=\"images/puntos_img/technicite1.jpg\" /></li>  <li><img src=\"images/puntos_img/technicite2.jpg\"/></li>  <li><img src=\"images/puntos_img/technicite3.jpg\" /></li><li><img src=\"images/puntos_img/technicite4.jpg\" /></li><li><img src=\"images/puntos_img/technicite5.jpg\" /></li>"

            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                    4.89317423761, 43.9165467661,
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "Name": "HOTEL ENTREPRISE LA BARBIERE",
                "description": "<p>Situé au carrefour des grands axes de communication du territoire, le Château de la Barbière vise à favoriser le développement d’entreprises dans les quartiers prioritaires d’Avignon.</p>",
                "SiteWeb": "<a href =\"http://www.citadis-avignon.com/index.php/references-construction/immobiliers-dentreprises/328-avignon-chateau-de-la-barbiere\" target =\"_blank\"> http://www.citadis-avignon.com/index.php/references-construction/immobiliers-dentreprises/328-avignon-chateau-de-la-barbiere",
                "Contac": "\nGrand Avignon Entreprendre<br> \nentreprendre@agglo-grandavignon.fr \n<br>04 90 84 48 20",
                "iconSize": [30, 30],
                "nameIcon": "hotelentreprise",
                "slider": "<li><img src=\"images/puntos_img/barbiere1.jpg\" /></li>  <li><img src=\"images/puntos_img/barbiere2.jpg\"/></li>  <li><img src=\"images/puntos_img/barbiere3.jpg\" /></li>"

            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                     4.832393346037378,43.93202747617863,
                ]
            }
        },
        
        
        
       
        
        {
            "type": "Feature",
            "properties": {
                "Name": "VILLAGE DES METIERS",
            "description": "<p>Idéalement situé dans Avignon, à deux pas des Bouches-du-Rhône et du Gard, ce Village accueille les entreprises artisanales et leur propose des locaux à la vente ou à la location, spécialement adaptés à leurs spécificités métier.</p>",
            "SiteWeb": "<a href =\"http://www.citadis-avignon.com/index.php/references-construction/immobiliers-dentreprises/328-avignon-chateau-de-la-barbiere\" target =\"_blank\"> http://www.citadis-avignon.com/index.php/references-construction/immobiliers-dentreprises/328-avignon-chateau-de-la-barbiere",
            "Contac": "\nGrand Avignon Entreprendre<br> \nentreprendre@agglo-grandavignon.fr \n<br>04 90 84 48 20",
            "iconSize": [30, 30],
            "nameIcon": "villagedesmetiers",
            "slider": "<li><img src=\"images/puntos_img/village des metiers1.jpg\" /></li>  <li><img src=\"images/puntos_img/village des metiers2.jpg\"/></li> "

            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                  4.80014571229, 43.9246870211,
                ]
            }
        },
         
             {
            "type": "Feature",
            "properties": {
                "Name": "HOTEL D'ENTREPRISE DE LA CROIX ROUGE",
                "description": "<p>A quelques minutes du centre-ville et bien desservi par les transports en commun, l’Hôtel d’entreprise de La Croix Rouge met à disposition les services d’un centre d’affaire, des bureaux et ateliers jusqu’à 230m2.</p>",
                "SiteWeb": "<a href =\"http://www.hotelentreprisecroixrouge.net/\" target =\"_blank\"> http://www.hotelentreprisecroixrouge.net/",
                "Contac": "\nGrand Avignon Entreprendre<br> \nentreprendre@agglo-grandavignon.fr \n<br>04 90 84 48 20",
                "iconSize": [30, 30],
                "nameIcon": "hotelentreprise",
                "slider": "<li><img src=\"images/puntos_img/croixrouge1.jpg\" /></li>  <li><img src=\"images/puntos_img/croixrouge2.jpg\"/></li>  <li><img src=\"images/puntos_img/croixrouge3.jpg\" /></li>"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                  4.82681704326, 43.9343851935,
                ]
            }
        },

         {
            "type": "Feature",
            "properties": {
                "Name": "FRENCH TECH",
                "description": "<p>Le territoire du Grand Avignon a reçu en 2015 le label French Tech sur la thématique culturelle, suite à la candidature initiée par l’association de préfiguration qui regroupait le Festival d’Avignon, l’Université et les entreprises du numérique.\nL’accélérateur «The Bridge» fait partie des outils mis en place dans le cadre de ce label. Il a pour objectif de sélectionner puis d’accompagner des startups afin d’accélérer leur développement par la mise à disposition de compétences et de moyens techniques. \n«The Bridge» réalise deux sessions d’accélération par an par le biais d’un appel à projet.</p>",
                "SiteWeb": "<a href =\"http://www.thebridge-accelerator.eu/\" target =\"_blank\"> http://www.thebridge-accelerator.eu/",
                "Contac": "\nGrand Avignon Entreprendre<br> \nentreprendre@agglo-grandavignon.fr \n<br>04 90 84 48 20",
                "iconSize": [30, 30],
                "nameIcon": "frenchtech",
                "slider": "<li><img src=\"images/puntos_img/frenchtech1.jpg\" /></li>  <li><img src=\"images/puntos_img/frenchtech2.jpg\"/></li>"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                  4.80204809734, 43.9424509225,
                ]
            }
        },


           {
            "type": "Feature",
            "properties": {
                "Name": "TERRALIA",
                 "description": "<p>Créé en 2005, le pôle de compétitivité PEIFL, devenu aujourd’hui TERRALIA anime un écosystème de partenariats entre les entreprises, les centres de recherche et les organismes de formation afin de favoriser le développement économique  et la création d’emplois.\nL’enjeu est de s’appuyer sur les synergies et la confiance créée entre les acteurs par l'intermédiaire de coopération concrète dans des projets collaboratifs et innovants.\nIl s'agit de permettre aux entreprises impliquées de prendre une position de premier plan dans leurs domaines en France et à l’international.</p>",
                 "SiteWeb": "<a href =\"http://www.pole-terralia.com/fr\" target =\"_blank\"> http://www.pole-terralia.com/fr",
                 "Contac": "\nGrand Avignon Entreprendre<br> \nentreprendre@agglo-grandavignon.fr \n<br>04 90 84 48 20",
                 "iconSize": [30, 30],
                 "nameIcon": "terralia",
                 "slider": "<li><img src=\"images/puntos_img/terralia1.jpg\" /></li>  <li><img src=\"images/puntos_img/terralia2.jpg\"/></li>  <li><img src=\"images/puntos_img/terralia3.jpg\" /></li>"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                  4.878455, 43.9260433,
                ]
            }
        },

           

    
        
    ]
};



 

 var mislider = $('.bxslider').bxSlider({});


geojson.features.forEach(function(marker) {

    // create a DOM element for the marker
    var el = document.createElement('div');
    var closebtn = document.getElementById('closebtnSiderbar');
    var closebtn2 = document.getElementById('closebtnSiderbar2');
    


    $(".sombra").click(function() {
         console.log("sombra");
         el.style.backgroundImage = 'url(./images/composition/pines/' + marker.properties.nameIcon + '-off.png)';
         popup.remove(); 
         $( this ).hide();
   });


    var btn_off = 'url(./images/composition/pines/' + marker.properties.nameIcon + '-off.png)';
    var timeout;
    var count = 0;
    var bandera = true
    var descripcionx = document.getElementById('descripcion_siderbar'); 
    
     


    el.className = 'marker';
    el.style.backgroundImage = 'url(./images/composition/pines/' + marker.properties.nameIcon + '-off.png)';
    el.style.backgroundSize = "30px 30px";
    el.style.width = marker.properties.iconSize[0] + 'px';
    el.style.height = marker.properties.iconSize[1] + 'px';




 

    //  FUNCIONALIDAD CUANDO HACEMOS CLIC EN LOS MARCADORES  
    el.addEventListener('click', function(x) {
        //window.alert(marker.properties.message);

        MostrarSiderBar()
        $("#info").mCustomScrollbar("destroy");

        x.preventDefault();
        x.stopPropagation();

          $( ".sombra" ).trigger('click');

          map.flyTo({center: marker.geometry.coordinates});

 
        

    });  

  

 
    function MostrarSiderBar(){



        if (bandera == true) {
 

            //cambiarIconosOff()
            // Comprobamos que este oculto el siderBar para mostrarlo 
            if ( $(".siderbar").css('display') == 'none' ){
                 $( ".siderbar" ).toggle( "slide", {direction: 'right'}, function(){ });
                 $( ".open_info_btn" ).hide();
                 $(".indicadoresColor").hide();



             }

             // Cerramos el siderbar 2 para solo mostrar el de los puntos 
            if ( $(".siderbar2").css('display') == 'block' ){
                 $( ".siderbar2" ).toggle( "slide", {direction: 'right'}, function(){
                   $( ".open_info_btn" ).fadeIn();
                 }); 
             }



        // Cacheing HTML elements
        var project = document.querySelector('#info');
        project.style.opacity = 0;

       


        setTimeout(function(){ 
            el.style.backgroundImage = 'url(./images/composition/pines/' + marker.properties.nameIcon + '-on.png)';
        },200);

        setTimeout(function(){ 
           // Agregamos las propiedades de descripción con innerHTML
            document.getElementById('titulo_siderbar').innerHTML =  marker.properties.Name;
            //document.getElementById('descripcion_siderbar').innerHTML =  marker.properties.description;
            //descripcionx.append("marker.properties.description");

            $.ajax({url: "", 
            success: function(result){
                //$("#descripcion_siderbar").html(result);
                //$("#descripcion_siderbar").mCustomScrollbar()
                document.getElementById('descripcion_siderbar').innerHTML =  marker.properties.description;
                document.getElementById('sliderX').innerHTML =  marker.properties.slider;
                document.getElementById('WebSiteSiderbar').innerHTML = "<span class='yellow'> Site web :</span>" + marker.properties.SiteWeb;
                document.getElementById('ContactSiderbar').innerHTML = "<span class='yellow'> Contact : </span>" +  marker.properties.Contac;

                console.log("Succes!!!")
                $("#info").mCustomScrollbar({theme:"minimal",
                    advanced:{
                        updateOnContentResize: true
                    }
                });

                $("#info").mCustomScrollbar("update");

                // Recargamos el slider
                mislider.reloadSlider()
            
            }});


            project.style.opacity = 1;
            //el.style.backgroundImage = 'url(./images/composition/pines/' + marker.properties.nameIcon + '-on.png)';
             
        },400);

       return;
         }

         return;

    }


    // FUNCIONALIDAD DE CUANDO CERRAMOS EL SIDERBAR QUITE LOS ELEMENTOS MARCADOS 
     closebtn.addEventListener('click', function() { 
        el.style.backgroundImage = 'url(./images/composition/pines/' + marker.properties.nameIcon + '-off.png)';
         popup.remove(); 
         $( ".sombra" ).hide();
    });

    closebtn2.addEventListener('click', function() { 
        el.style.backgroundImage = 'url(./images/composition/pines/' + marker.properties.nameIcon + '-off.png)';
         popup.remove();
         $( ".sombra" ).hide(); 
    });

  
   



   

    // add marker to map
    new mapboxgl.Marker(el, {offset: [-marker.properties.iconSize[0] / 2, -marker.properties.iconSize[1] / 2]})
        .setLngLat(marker.geometry.coordinates)
        .addTo(map);


        // Create a popup, but don't add it to the map yet.
        var popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });



    /*el.addEventListener('mouseover', function() {
         
        popup.setLngLat(marker.geometry.coordinates)
        .setHTML(marker.properties.Name)
        .addTo(map);

    });*/



    // FUNCIONALIDAD PARA MOVILES: 
    if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        
    //preload mouse down image here via Image()
    $( el ).bind('touchstart', function(){
       
        timeout = setInterval(function(){
                popup.setLngLat(marker.geometry.coordinates)
                .setHTML(marker.properties.Name)
                .addTo(map);
                bandera = false
                console.log(bandera)
        
            }, 800);

    }).bind('touchend', function(){
        clearInterval(timeout);
        //popup.remove();


         setTimeout(function(){ 
            bandera = true
            
            console.log(bandera)
        },500);
    });

    } // IF 



    // FUNCIONALIDAD PARA WEB:  FUNCIONALIDAD DE HOLD EN LOS MARCADORES PARA APARECER NOMBRE
    else {

   el.addEventListener('mouseover', function() {
        popup.setLngLat(marker.geometry.coordinates)
        .setHTML(marker.properties.Name)
        .addTo(map);
    });



    el.addEventListener ("mousedown", function () {



        timeout = setInterval(function(){


                popup.setLngLat(marker.geometry.coordinates)
                .setHTML(marker.properties.Name)
                .addTo(map);

                bandera = false
                console.log(bandera)
                
            }, 800);

    }, false);

    el.addEventListener ("mouseup", function () {
        clearInterval(timeout);

         setTimeout(function(){ 
            bandera = true
            console.log(bandera)
        },500);
           

        return false;

     });

    

    } //ELSE 

    


    el.addEventListener('mouseout', function() {  
       popup.remove();
       return;
    }); 



    function cambiarIconosOff(){
        $( ".marker" ).css("background-image", btn_off);
    }
    


 
});




});



 



 



 